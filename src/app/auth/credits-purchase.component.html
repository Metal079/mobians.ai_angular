<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [closable]="!processing"
  [dismissableMask]="!processing"
  [draggable]="false"
  [resizable]="false"
  [style]="{width: '95vw', maxWidth: '500px'}"
  (onHide)="close()"
  header="Buy Credits">

  <div class="purchase-content">
    <!-- Loading state -->
    @if (loading) {
      <div class="loading-state">
        <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
        <p>Loading packages...</p>
      </div>
    }

    <!-- Package selection -->
    @if (!loading) {
      <div class="packages-grid">
        @for (pkg of packages; track pkg) {
          <div
            class="package-card"
            [class.selected]="selectedPackage?.id === pkg.id"
            [class.popular]="pkg.id === 'popular'"
            [class.best-value]="pkg.id === 'best_value'"
            (click)="selectPackage(pkg)">
            @if (pkg.id === 'popular') {
              <div class="badge popular-badge">Better Value</div>
            }
            @if (pkg.id === 'best_value') {
              <div class="badge value-badge">Best Value</div>
            }
            <div class="package-name">{{ pkg.name }}</div>
            <div class="package-credits">{{ pkg.credits | number }} credits</div>
            <div class="package-price">${{ pkg.price_usd | number:'1.0-0' }}</div>
            @if (getBonus(pkg) > 0) {
              <div class="package-bonus">
                +{{ getBonus(pkg) }}% bonus!
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- PayPal buttons container -->
    @if (selectedPackage && !loading) {
      <div class="paypal-section">
        <div class="selected-summary">
          <span>Selected:</span>
          <strong>{{ selectedPackage.name }}</strong>
          <span class="price">${{ selectedPackage.price_usd | number:'1.2-2' }}</span>
        </div>
        @if (processing) {
          <div class="processing-overlay">
            <i class="pi pi-spin pi-spinner" style="font-size: 1.5rem;"></i>
            <span>Processing payment...</span>
          </div>
        }
        <div #paypalContainer class="paypal-buttons" [class.hidden]="processing"></div>
        @if (!paypalReady && selectedPackage) {
          <p class="loading-paypal">
            <i class="pi pi-spin pi-spinner"></i> Loading payment options...
          </p>
        }
      </div>
    }

    <!-- Info footer -->
    <div class="info-footer">
      <p><i class="pi pi-info-circle"></i> Payments are processed securely by PayPal. You can pay with PayPal balance or credit/debit card.</p>
      <p><i class="pi pi-lock"></i> All purchases are final. Credits do not expire.</p>
    </div>
  </div>
</p-dialog>
