<!-- Minimized state: just a small pill -->
@if (isMinimized) {
  <div class="minimized-pill"
    (click)="toggleMinimize()"
    (touchend)="toggleMinimize(); $event.preventDefault()">
    <span class="pi pi-user"></span>
    @if (isLoggedIn) {
      <span class="credits-badge">{{ credits }}</span>
    }
    @if (canClaimDailyBonus) {
      <span class="bonus-dot"></span>
    }
    <span class="pi pi-chevron-up" style="font-size:.75rem; margin-left:.25rem;"></span>
  </div>
}

<!-- Expanded state: full panel -->
@if (!isMinimized) {
  <div class="account-panel p-card" [ngStyle]="panelStyles">
    <!-- Header with user info and minimize button -->
    <div class="profile-header">
      <span class="pi pi-user" aria-hidden="true"></span>
      <span class="user-name">{{ userName || 'Account' }}</span>
      <button type="button" class="minimize-btn"
        (click)="toggleMinimize()"
        (touchend)="toggleMinimize(); $event.preventDefault()"
        title="Collapse panel"
        aria-label="Collapse panel">
        <span class="minimize-symbol" aria-hidden="true">-</span>
      </button>
    </div>
    <!-- Credits Section (only when logged in) -->
    @if (isLoggedIn) {
      <div class="credits-section">
        <div class="credits-row">
          <span class="credits-label">Credits</span>
          <span class="credits-value">{{ credits }}</span>
        </div>
        <!-- Buy Credits Button -->
        <button
          pButton
          type="button"
          class="p-button-outlined p-button-sm w-full buy-credits-btn"
          label="Buy Credits üí≥"
          icon="pi pi-shopping-cart"
          (click)="openPurchaseDialog()">
        </button>
        <!-- Daily Bonus -->
        @if (canClaimDailyBonus) {
          <button
            pButton
            type="button"
            class="p-button-success p-button-sm w-full"
            [label]="'Claim Daily +' + nextDailyBonus + ' üéÅ'"
            [loading]="claimingBonus"
            (click)="claimDaily()">
          </button>
        }
        @if (!canClaimDailyBonus && isLoggedIn) {
          <div class="daily-claimed">
            <span class="pi pi-check-circle"></span>
            Daily claimed!
            @if (dailyStreak > 1) {
              <span>üî• {{ dailyStreak }} day streak</span>
            }
          </div>
        }
        @if (isLoggedIn) {
          <div class="daily-note">
            Daily bonus starts at 30 and grows by 10/day up to 50 when you keep claiming. Miss a day and it resets.
          </div>
        }
      </div>
    }
    <!-- Sign up prompt for non-logged in users -->
    @if (!isLoggedIn) {
      <div class="signup-prompt">
        <div class="signup-title">üéÅ Sign up with Discord or Google for 100 free credits!</div>
        <div class="signup-subtitle">Daily bonus starts at 30 and ramps by +10 per day (up to 50) when you claim every day.</div>
      </div>
    }
    <!-- Admin Panel Button (only visible to admins/mods) -->
    @if (isLoggedIn && isAdmin) {
      <button pButton type="button"
        class="p-button-warning p-button-sm admin-btn"
        label="Admin Panel"
        icon="pi pi-cog"
        routerLink="/admin">
      </button>
    }
    <!-- Actions -->
    <div class="actions">
      @if (!isLoggedIn) {
        <button pButton type="button" class="p-button-sm w-full" label="Login" icon="pi pi-sign-in" (click)="login()"></button>
      }
      <!-- Only show Link Google if logged in via Google (not Discord) and don't have Google linked yet -->
      @if (isLoggedIn && !hasGoogle && !hasDiscord) {
        <button pButton type="button" class="p-button-outlined p-button-sm" label="Link Google" icon="pi pi-google" (click)="link('google')"></button>
      }
      <!-- Only show Link Discord if logged in via Discord (not Google) and don't have Discord linked yet -->
      @if (isLoggedIn && !hasDiscord && !hasGoogle) {
        <button pButton type="button" class="p-button-outlined p-button-sm" label="Link Discord" icon="pi pi-discord" (click)="link('discord')"></button>
      }
      @if (isLoggedIn) {
        <button pButton type="button" class="p-button-text p-button-sm" label="Logout" icon="pi pi-sign-out" (click)="logout()"></button>
      }
      @if (isLoggedIn && (hasGoogle || hasDiscord)) {
        <span class="linked-accounts">
          Linked: {{ hasGoogle ? 'Google' : '' }}{{ hasGoogle && hasDiscord ? ', ' : '' }}{{ hasDiscord ? 'Discord' : '' }}
        </span>
      }
    </div>
  </div>
}

<!-- Credits Purchase Dialog -->
<app-credits-purchase
  [(visible)]="showPurchaseDialog"
  (purchaseComplete)="onPurchaseComplete($event)">
</app-credits-purchase>
