<div class="request-loras-shell p-fluid">
  <section class="request-loras-hero">
    <div class="hero-copy">
      <h4>Request a LoRA</h4>
      <p>Search CivitAI by name, model ID, or creator and submit exactly what you want added.</p>
    </div>
  </section>

  <div class="search-mode-group" id="search-options">
    @for (option of searchOptions; track option.value) {
      <button
        pButton
        type="button"
        [label]="option.label"
        [icon]="option.icon"
        class="search-mode-btn"
        [class.p-button-primary]="selectedSearchOption === option.value"
        [class.p-button-outlined]="selectedSearchOption !== option.value"
        (click)="selectOption(option.value)">
      </button>
    }
  </div>

  <section class="search-panel">
    <label class="search-label" for="lora-search-input">
      {{ selectedSearchOption === 'username' ? 'Creator Username' : selectedSearchOption === 'model_id' ? 'Model ID' : 'LoRA Name' }}
    </label>
    <div class="search-input-row">
      <input
        id="lora-search-input"
        type="text"
        pInputText
        [(ngModel)]="searchField"
        [placeholder]="getSearchPlaceholder()"
        (keyup.enter)="search()" />
      <button
        pButton
        type="button"
        label="Search"
        icon="pi pi-search"
        class="search-submit-btn p-button-primary"
        (click)="search()"
        [disabled]="isLoading || !searchField">
      </button>
    </div>
    <div class="search-actions-row">
      <label class="nsfw-toggle">
        <span>Show NSFW results</span>
        <p-toggleswitch [(ngModel)]="showNSFWLoras" [class]="'ms-2'" (ngModelChange)="onShowNsfwChanged()"></p-toggleswitch>
      </label>
      @if (isLoading) {
        <div class="inline-loading">
          <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
          <span>Searching CivitAI...</span>
        </div>
      }
    </div>
  </section>

  @if (userPendingSuggestions.length > 0) {
    <section class="pending-card">
      <div class="pending-toggle">
        <button
          pButton
          type="button"
          [label]="showPendingRequests ? 'Hide my pending requests' : 'Show my pending requests'"
          [icon]="showPendingRequests ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
          class="p-button-outlined pending-toggle-btn"
          (click)="togglePendingRequests()">
        </button>
        <span class="pending-count">{{ userPendingSuggestions.length }}</span>
        @if (loadingStatuses) {
          <p-progressSpinner strokeWidth="3" animationDuration=".5s"></p-progressSpinner>
        }
      </div>

      @if (showPendingRequests) {
        <div class="pending-requests">
          <div class="pending-header">
            <div class="pending-title">Your pending requests</div>
          </div>
          <div class="pending-list">
            @for (item of userPendingSuggestions; track item) {
              <div class="pending-item">
                <div class="pending-info">
                  <div class="pending-name">{{ item.name }}</div>
                  <div class="pending-meta">
                    {{ item.version || 'Unknown version' }} â€¢ {{ item.base_model || 'Unknown base model' }}
                  </div>
                </div>
                <button
                  pButton
                  type="button"
                  label="Cancel"
                  icon="pi pi-times"
                  class="p-button-danger pending-cancel-btn"
                  (click)="cancelSuggestion(item)">
                </button>
              </div>
            }
          </div>
        </div>
      }
    </section>
  }

  @if (!isLoading && hasSearched && searchResults.length === 0) {
    <div class="empty-results">
      <i class="pi pi-search"></i>
      <h6>No matching LoRAs found</h6>
      <p>Try another keyword, creator name, or model ID.</p>
    </div>
  }

  @if (!isLoading && searchResults && searchResults.length > 0) {
    <div class="results-header">
      <h6>Search Results</h6>
      <span class="results-count">{{ searchResults.length }}</span>
    </div>

    <div class="mobile-results">
      @for (lora of searchResults; track lora) {
        <div
          class="lora-card"
          [ngClass]="[getLoraStatusClass(lora), lora === selectedLoRA ? 'selected' : '']"
          (click)="selectLora(lora)">
          <div class="lora-card-header">
            @if (lora.images && lora.images.length > 0) {
              <img
                [src]="lora.images[0].url"
                alt="LoRA Preview"
                class="preview-image"
                (click)="previewImage($event, lora.images[0].url)" />
            } @else {
              <div class="preview-image placeholder">
                <i class="pi pi-image"></i>
              </div>
            }
            <div class="lora-card-title-wrap">
              <div class="lora-card-title">{{ lora.name }}</div>
              <div class="lora-card-subtitle">by {{ lora.creator?.username || 'Unknown creator' }}</div>
            </div>
            @if (getLoraStatus(lora); as status) {
              <span class="status-pill" [ngClass]="'status-' + status">{{ statusLabels[status] }}</span>
            }
          </div>

          <div class="lora-card-body">
            <div class="lora-stats">
              <div><strong>Downloads:</strong> {{ lora.stats?.downloadCount || 0 }}</div>
              <div><strong>Rating:</strong> <i class="pi pi-thumbs-up"></i> {{ lora.stats?.thumbsUpCount || 0 }} <i class="pi pi-thumbs-down"></i> {{ lora.stats?.thumbsDownCount || 0 }}</div>
              <div><strong>Base Model:</strong> {{ lora.base_model || 'Unknown' }}</div>
            </div>
            <div class="lora-tags">
              @for (tag of lora.tags || []; track tag) {
                <p-chip [label]="tag"></p-chip>
              }
            </div>
            <a class="lora-model-link" [href]="'https://civitai.com/models/' + lora.model_page_id" target="_blank" rel="noopener noreferrer" (click)="$event.stopPropagation()">
              View model page
            </a>
          </div>
        </div>
      }
    </div>
  }

  @if (selectedLoRA) {
    <div class="lora-request-button">
      <button pButton type="button" icon="pi pi-send" label="Request Selected LoRA" class="p-button-primary" (click)="requestSelectedLoRA()"></button>
    </div>
  }

  <p-dialog header="Preview Image" [(visible)]="showImageDialog" [draggable]="false" (onHide)="showImageDialog = false">
    <img [src]="imageToShow" alt="Expanded Preview" style="width: 100%;" />
  </p-dialog>
</div>
