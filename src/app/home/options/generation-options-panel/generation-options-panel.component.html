<!-- Options Content Panel -->
<div class="collapse w-100" id="collapseExample">
  <div class="card card-body">
    <!-- Existing options content -->
    <label for="floatingSelect">Model Select</label>
    <select class="form-select" id="floatingSelect" aria-label="Floating label select example"
      [(ngModel)]="generationRequest.model" (change)="modelChange.emit($event)">
      <option value="sonicDiffusionV4">SonicDiffusionV4</option>
      <option value="autismMix">autismMix</option>
      <option value="novaFurryXL_ilV140">novaFurryXL_ilV140</option>
      <option value="novaMobianXL_v10">novaMobianXL_v10</option>
    </select>

    <label for="floatingSelect">Image aspect-ratio</label>
    <select class="form-select" id="floatingSelect" aria-label="Floating label select example"
      [(ngModel)]="aspectRatio['aspectRatio']" (change)="aspectRatioChange.emit($event)">
      <option value="square">Square</option>
      <option value="landscape">Landscape</option>
      <option value="portrait">Portrait</option>
    </select>

    <label for="themeSelect">Site Theme</label>
    <select class="form-select" id="themeSelect" aria-label="Panel theme select"
      [ngModel]="panelTheme" (ngModelChange)="onPanelThemeChange($event)">
      <option value="sonic">Sonic Blue</option>
      <option value="navy">Navy</option>
    </select>

    <div class="d-flex justify-content-start mb-3 mt-2">
      <div class="form-check me-3">
        <input class="form-check-input" type="checkbox" [ngModel]="darkInputFields"
          (ngModelChange)="onDarkInputFieldsChange($event)" id="darkTextFields">
        <label class="form-check-label" for="darkTextFields">Dark text boxes</label>
      </div>
    </div>

    <!-- Negative Prompt -->
    <div class="mb-3">
      <label for="negative-prompt-input" class="form-label">Negative Prompt
        <span class="ms-1 text-primary"
          pTooltip="Add terms you want the AI to avoid when generating the image. Separate each term with a comma. By default a negative prompt is provided so this does not need to be modifed unless the below negative does not work well for you."
          tooltipPosition="top" style="
            cursor: pointer;
          ">
          ?
        </span>
      </label>
      <textarea class="form-control" id="negative-prompt-input" rows="3"
      [(ngModel)]="generationRequest.negative_prompt" (ngModelChange)="saveSettings.emit()"></textarea>
    </div>

    <section class="regional-panel mb-3">
      <div class="regional-header">
        <div class="regional-title-wrap">
          <h5 class="regional-title">Regional Prompting</h5>
          <p class="regional-subtitle mb-0">Give different areas of the image their own prompt details.</p>
        </div>
        <div class="form-check form-switch">
          <input
            class="form-check-input"
            type="checkbox"
            id="regionalPromptingEnabled"
            [disabled]="!regionalPromptingSupported"
            [(ngModel)]="regionalEnabled">
          <label class="form-check-label" for="regionalPromptingEnabled">Enable</label>
        </div>
      </div>
      @if (!regionalPromptingSupported) {
        <small class="text-muted">Regional prompting is available only for SDXL models.</small>
      }

      <div class="regional-actions">
        <button class="btn btn-sm regional-action-btn primary" type="button" [disabled]="!regionalPromptingSupported" (click)="addRegion()">+ Add</button>
        <button class="btn btn-sm regional-action-btn" type="button" [disabled]="!regionalPromptingSupported" (click)="addRegion('left-right')">Left / Right</button>
        <button class="btn btn-sm regional-action-btn" type="button" [disabled]="!regionalPromptingSupported" (click)="addRegion('top-bottom')">Top / Bottom</button>
        <button class="btn btn-sm regional-action-btn danger" type="button" [disabled]="!regionalPromptingSupported" (click)="clearRegions()">Clear</button>
      </div>

      <div class="regional-presets">
        <div class="regional-preset-row">
          <input
            class="form-control form-control-sm"
            placeholder="Preset name"
            [(ngModel)]="newPresetName"
            [disabled]="!canManagePresets || !regionalPromptingSupported">
          <button
            class="btn btn-sm regional-action-btn primary"
            type="button"
            [disabled]="!canManagePresets || !regionalPromptingSupported"
            (click)="saveCurrentAsPreset()">Save Preset</button>
        </div>
        @if (regionalPresets.length > 0) {
          <div class="regional-preset-chip-row">
            @for (preset of regionalPresets; track preset.id) {
              <button class="regional-chip" type="button" (click)="applyPreset(preset.id)">{{ preset.name }}</button>
              <button
                class="btn btn-sm regional-action-btn danger preset-delete-btn"
                type="button"
                [disabled]="!canManagePresets || !regionalPromptingSupported"
                (click)="removePreset(preset.id, preset.name)">×</button>
            }
          </div>
        }
        <small class="regional-storage-hint">
          {{ isLoggedIn ? 'Presets are saved to your account.' : 'Sign in to save and manage presets.' }}
        </small>
      </div>

      <div class="regional-editor-toggle-row">
        <button
          class="btn btn-sm regional-action-btn"
          type="button"
          [disabled]="(!regionalEnabled && !hasRegions) || !regionalPromptingSupported"
          (click)="toggleWorkspace()">
          {{ workspaceExpanded ? 'Hide Workspace' : 'Edit Regions' }}
        </button>
        <span class="regional-summary-text">
          {{ hasRegions ? (regionalRegions.length + ' region(s) configured') : 'No regions configured' }}
        </span>
      </div>

      @if (workspaceExpanded) {
        <div class="regional-workspace-shell" [class.enabled]="regionalEnabled">
          @if (!regionalEnabled) {
            <div class="regional-disabled-overlay">
              <p class="mb-0">Enable regional prompting to edit and drag regions.</p>
            </div>
          }
          <div class="regional-workspace">
            <div class="regional-preview-column">
              <div class="regional-preview">
                <div class="regional-preview-frame" [style.aspect-ratio]="previewAspectRatio">
                @for (region of regionalRegions; track region.id; let i = $index) {
                  <button
                    type="button"
                    class="regional-preview-box"
                    [class.active]="i === activeRegionIndex"
                    [style.left.%]="region.x * 100"
                    [style.top.%]="region.y * 100"
                    [style.width.%]="region.width * 100"
                    [style.height.%]="region.height * 100"
                    (pointerdown)="onPreviewPointerDown($event, i)"
                    (pointermove)="onPreviewPointerMove($event, i)"
                    (pointerup)="onPreviewPointerUp($event, i)"
                    (pointercancel)="onPreviewPointerUp($event, i)"
                    (click)="selectRegion(i)">
                    <span>R{{ i + 1 }}</span>
                  </button>
                }
                </div>
              </div>

              @if (hasRegions) {
                <div class="regional-chip-list">
                  @for (region of regionalRegions; track region.id; let i = $index) {
                    <button
                      type="button"
                      class="regional-chip"
                      [class.active]="i === activeRegionIndex"
                      (click)="selectRegion(i)">
                      Region {{ i + 1 }}
                    </button>
                  }
                </div>
              }
            </div>

            <div class="regional-editor-column">
              @if (selectedRegion; as region) {
                <article class="regional-region-card">
                  <div class="regional-region-head">
                    <h6 class="mb-0">Editing Region {{ activeRegionIndex + 1 }}</h6>
                    <button class="btn btn-sm regional-action-btn danger" type="button" (click)="removeRegion(activeRegionIndex)">Remove</button>
                  </div>

                  <label class="form-label mb-1">Region Prompt
                    <span class="regional-help-icon"
                      pTooltip="Describe only what should appear inside this region."
                      tooltipPosition="top">?</span>
                  </label>
                  <textarea
                    class="form-control mb-2"
                    rows="2"
                    [(ngModel)]="region.prompt"
                    (ngModelChange)="saveSettings.emit()"
                    placeholder="Describe this area"></textarea>

                  <label class="form-label mb-1">Region Negative Prompt (optional)
                    <span class="regional-help-icon"
                      pTooltip="Things to avoid in this region (wrong character, colors, clothing, etc)."
                      tooltipPosition="top">?</span>
                  </label>
                  <input
                    class="form-control mb-2"
                    [(ngModel)]="region.negative_prompt"
                    (ngModelChange)="saveSettings.emit()"
                    placeholder="What to avoid in this area">

                  <div class="form-check mb-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [id]="'inheritBasePrompt-' + activeRegionIndex"
                      [(ngModel)]="region.inherit_base_prompt"
                      (ngModelChange)="saveSettings.emit()">
                    <label class="form-check-label" [for]="'inheritBasePrompt-' + activeRegionIndex">
                      Include base prompt context in this region's prompt
                      <span class="regional-help-icon"
                        pTooltip="When ON, this region also inherits the global prompt. Turn OFF for stronger separation."
                        tooltipPosition="top">?</span>
                    </label>
                  </div>

                  <div class="regional-grid">
                    <div class="regional-slider-pair">
                      <div class="regional-slider-item">
                        <label class="form-label">X: {{ (region.x * 100).toFixed(0) }}%
                          <span class="regional-help-icon" pTooltip="Horizontal position of the region." tooltipPosition="top">?</span>
                        </label>
                        <input type="range" class="form-range" min="0" max="1" step="0.01"
                          [(ngModel)]="region.x" (ngModelChange)="normalizeRegion(region)">
                      </div>

                      <div class="regional-slider-item">
                        <label class="form-label">Y: {{ (region.y * 100).toFixed(0) }}%
                          <span class="regional-help-icon" pTooltip="Vertical position of the region." tooltipPosition="top">?</span>
                        </label>
                        <input type="range" class="form-range" min="0" max="1" step="0.01"
                          [(ngModel)]="region.y" (ngModelChange)="normalizeRegion(region)">
                      </div>
                    </div>

                    <div class="regional-slider-pair">
                      <div class="regional-slider-item">
                        <label class="form-label">Width: {{ (region.width * 100).toFixed(0) }}%
                          <span class="regional-help-icon" pTooltip="How much horizontal area this region covers." tooltipPosition="top">?</span>
                        </label>
                        <input type="range" class="form-range" min="0.05" max="1" step="0.01"
                          [(ngModel)]="region.width" (ngModelChange)="normalizeRegion(region)">
                      </div>

                      <div class="regional-slider-item">
                        <label class="form-label">Height: {{ (region.height * 100).toFixed(0) }}%
                          <span class="regional-help-icon" pTooltip="How much vertical area this region covers." tooltipPosition="top">?</span>
                        </label>
                        <input type="range" class="form-range" min="0.05" max="1" step="0.01"
                          [(ngModel)]="region.height" (ngModelChange)="normalizeRegion(region)">
                      </div>
                    </div>

                    <label class="form-label">Region Influence: {{ region.denoise_strength.toFixed(2) }}
                      <span class="regional-help-icon" pTooltip="How strongly this region prompt affects the result in this area." tooltipPosition="top">?</span>
                    </label>
                    <input type="range" class="form-range" min="0" max="1" step="0.05"
                      [(ngModel)]="region.denoise_strength" (ngModelChange)="normalizeRegion(region)">

                    <label class="form-label">Edge Softness: {{ region.feather }} px
                      <span class="regional-help-icon" pTooltip="Softens boundaries between regions. Lower values reduce concept bleeding." tooltipPosition="top">?</span>
                    </label>
                    <input type="range" class="form-range" min="0" max="96" step="2"
                      [(ngModel)]="region.feather" (ngModelChange)="normalizeRegion(region)">
                  </div>
                </article>
              } @else {
                <div class="regional-empty-state">
                  <h6>No regions yet</h6>
                  <p>Create one with <strong>Add</strong> or use a split preset to start quickly.</p>
                </div>
              }
            </div>
          </div>
        </div>
      }
    </section>

    <div class="mb-3" style="display: flex; justify-content: space-between; flex-wrap: wrap;">
      <!-- Seed -->
      <div style="width: 49%; flex-basis: calc(49%);">
        <label for="seedInput" class="form-label">
          Seed
          <span class="ms-1 text-primary"
            pTooltip="Each generated image has a specific seed, if that seed is entered with the same prompt, you can regenerate the same or very similar images. By default a random seed is used with each generation."
            tooltipPosition="top"
            style="background-color: rgba(255, 255, 255, 0.8); padding: 2px 4px; border-radius: 50%; cursor: pointer;">
            ?
          </span>
        </label>
        <input type="number" class="form-control" id="seedInput1" placeholder="-1"
          [(ngModel)]="generationRequest.seed" />
        </div>

        <!-- Selected Image Seed -->
        <div style="width: 49%; flex-basis: calc(49%);">
          <label for="seedInput2" class="form-label">
            Current Seed
            <span class="ms-1 text-primary"
              pTooltip="The current seed of the currently generated images. This can be used to regenerate the same/or very similar image."
              tooltipPosition="top"
              style="background-color: rgba(255, 255, 255, 0.8); padding: 2px 4px; border-radius: 50%; cursor: pointer;">
              ?
            </span>
          </label>
          <input type="number" class="form-control" id="seedInput2" placeholder="Generate to see seed."
            [(ngModel)]="currentSeed" disabled="true" [value]="currentSeed" />
          </div>
        </div>

        <!-- CFG -->
        <label for="customRange1" class="form-label">CFG: <span id="cfg-value">{{ generationRequest.guidance_scale
        }}</span>
        <span class="ms-1 text-primary"
          pTooltip="CFG refers to how closely a image tries follow to a prompt, too high values may fry images, while too low of a value will result in an unrelated photo being generated but generally more creative/pretty. By default 7 is used but this can be experimented with."
        tooltipPosition="top" style="
          background-color: rgba(255, 255, 255, 0.8);
          padding: 2px 4px;
          border-radius: 50%;
          cursor: pointer;
        ">
          ?
        </span>
      </label>
      <input type="range" class="form-range" min="2" max="15" value="7" id="customRange1"
        [(ngModel)]="generationRequest.guidance_scale" (ngModelChange)="saveSettings.emit()" />

        <!-- FastPass Code -->
        <div class="mb-3">
          <label for="fastPassCode" class="form-label">
            FastPass Code
            <span class="ms-1 text-primary"
              pTooltip="FastPass codes are given weekly to contest winners on the discord! They allow you skip the queue. If you have a code, enter it here! Join the discord to learn more."
              tooltipPosition="top"
              style="background-color: rgba(255, 255, 255, 0.8); padding: 2px 4px; border-radius: 50%; cursor: pointer;">
              ?
            </span>
          </label>
          <input type="password" class="form-control" id="fastPassCode" placeholder="Join the Discord to win!"
            [(ngModel)]="generationRequest.fast_pass_code" (input)="fastPassCodeChange.emit($event)" />
          </div>

          <!-- Hi-Res (Generate + Upscale) -->
          @if (generationRequest.job_type == 'txt2img' && !referenceImage) {
            <div
              class="d-flex justify-content-start mb-3">
              <div class="form-check me-3">
                <input class="form-check-input" type="checkbox" [ngModel]="hiresEnabled"
                  (ngModelChange)="onHiresEnabledChange($event)" id="hiresToggle" [disabled]="!isLoggedIn">
                  <label class="form-check-label" for="hiresToggle">
                    Enhanced Quality (Generate + Upscale)
                    <span class="ms-1 text-primary"
                      [pTooltip]="hiresTooltip"
            tooltipPosition="top" style="
            background-color: rgba(255, 255, 255, 0.8);
            padding: 2px 4px;
            border-radius: 50%;
            cursor: pointer;
            ">
                      ?
                    </span>
                  </label>
                </div>
              </div>
            }

            <!-- Notifications -->
            <div class="d-flex justify-content-start mb-3">
              <div class="form-check me-3">
                <input class="form-check-input" type="checkbox" [ngModel]="enableNotifications"
                  (ngModelChange)="onEnableNotificationsChange($event)" id="notification">
                  <label class="form-check-label" for="notification">Send Notification When Image Completes</label>
                </div>
              </div>

              <!-- Toggle to return webp images isntead of png, (much smaller image sizes!) -->
              <div class="d-flex justify-content-start mb-3">
                <div class="form-check me-3">
                  <input class="form-check-input" type="checkbox" [(ngModel)]="generationRequest.lossy_images" id="returnWebp"
                    (ngModelChange)="saveSettings.emit()">
                    <label class="form-check-label" for="returnWebp">WebP Images (Much smaller image size. Disable to save images as
                    png when downloading!)</label>
                  </div>
                </div>

                <!-- Reset session storage and image history actions -->
                <div class="history-maintenance-actions">
                  <button class="btn btn-danger btn-sm" type="button" (click)="resetSessionStorage.emit()" id="reset-session-storage-button">
                    Reset Saved Options
                  </button>

                  <button
                    class="btn btn-success btn-sm"
                    type="button"
                    (click)="downloadAllImages.emit()"
                    [disabled]="downloadAllInProgress"
                    id="download-all-images-button"
                    title="Download all image history as ZIP"
                    aria-label="Download all image history">
                    {{ downloadAllInProgress ? 'Preparing download…' : 'Download Image History' }}
                  </button>

                  <button class="btn btn-danger btn-sm" type="button" (click)="deleteAllImages.emit()" id="delete-all-images-button">
                    Delete Image History
                  </button>
                </div>
              </div>
            </div>
