<!-- Image History Content Panel -->
<div class="collapse w-100" id="historyCollapse">
  <div class="card card-body">
    <p-tabs [value]="historyTab" (valueChange)="historyTab = +($event ?? 0)">
      <p-tablist>
        <p-tab [value]="0">All Images</p-tab>
        <p-tab [value]="1">Favorites</p-tab>
      </p-tablist>
      <p-tabpanels>
        <!-- All Images Tab -->
        <p-tabpanel [value]="0">
        <div class="sorting-options">
          <div class="search-bar">
            <input type="text" pInputText placeholder="Search prompts" [ngModel]="searchQuery"
              (ngModelChange)="onSearchQueryChange($event)">
            </div>
            <div class="density-controls">
              <label class="density-label" for="imagesPerPageAll">Images per page</label>
              <select id="imagesPerPageAll" class="form-select form-select-sm" [ngModel]="imagesPerPage"
                (ngModelChange)="onImagesPerPageChange($event)" aria-label="Images per page">
                @for (option of imagesPerPageOptions; track option) {
                  <option [ngValue]="option">
                    {{ option }} per page
                  </option>
                }
              </select>
            </div>
          </div>
          <!-- Image History Panel -->
          <div class="history-grid" [style.--history-columns]="gridColumns" [class.compact-grid]="gridColumns >= 4">
            @if (isLoadingAll && currentPageImages.length === 0) {
              @for (_ of getPlaceholders(imagesPerPage); track _) {
                <div class="history-item placeholder">
                  <div class="image-container">
                    <div class="image-skeleton"></div>
                  </div>
                </div>
              }
            }
            @if (currentPageImages.length > 0) {
              @for (image of currentPageImages; track imageTrackKey(image, $index)) {
                <div class="history-item">
                  <div class="image-container">
                    <img [attr.src]="image.url || null" alt="Generated Image" loading="eager" decoding="sync"
                      (load)="onImageElementLoad(image, $event)" (error)="onImageElementError(image, $event)"
                      (click)="openImageDetails(image)">
                    <div class="top-left-icon">
                      <i class="fa" [ngClass]="image.favorite ? 'bi bi-star-fill' : 'bi bi-star'"
                      (click)="$event.stopPropagation(); toggleFavorite(image)" aria-label="Toggle Favorite"></i>
                    </div>
                    <div class="bottom-left-icon">
                      <i class="bi bi-download"
                        (click)="$event.stopPropagation(); downloadImage(image, $event)"
                      aria-label="Download Image"></i>
                    </div>
                    <div class="top-right-icon">
                      <i class="bi bi-trash" (click)="$event.stopPropagation(); deleteImage(image)"
                      aria-label="Delete Image"></i>
                    </div>
                    <div class="bottom-right-icon">
                      <i class="bi bi-info-circle" [class.active]="isImageInfoOpen(image)"
                      (click)="toggleImageInfo(image, $event)" aria-label="Image info"></i>
                    </div>
                    @if (isImageInfoOpen(image)) {
                      <div class="image-info-overlay"
                        (click)="$event.stopPropagation(); toggleImageInfo(image, $event)">
                        <div class="info-line">
                          <span class="info-label">Date</span>
                          <span class="info-value">{{ image.timestamp | date:'short' }}</span>
                        </div>
                        <div class="info-line">
                          <span class="info-label">Model</span>
                          <span class="info-value">{{ image.model || 'Unknown' }}</span>
                        </div>
                        <div class="info-line">
                          <span class="info-label">Seed</span>
                          <span class="info-value">{{ image.seed ?? '—' }}</span>
                        </div>
                        <div class="info-line">
                          <span class="info-label">LoRAs</span>
                          <span class="info-value">{{ formatLoras(image) }}</span>
                        </div>
                        <div class="info-line">
                          <span class="info-label">Prompt</span>
                          <span class="info-value">{{ image.promptSummary || image.prompt || 'No prompt' }}</span>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
              @for (_ of getPlaceholders(imagesPerPage - currentPageImages.length); track _) {
                <div
                  class="history-item placeholder ghost">
                  <div class="image-container">
                    <div class="image-skeleton"></div>
                  </div>
                </div>
              }
            }
          </div>
          <!-- Show message if no images are available -->
          @if (currentPageImages.length === 0 && !isLoadingAll) {
            <div class="no-images-message">
              No generated images available.
            </div>
          }
          <div class="pagination">
            <button class="btn btn-sm btn-primary" (click)="previousPage()"
            [disabled]="currentPageNumber === 1">Previous</button>
            <span class="page-edit-container">
              Page <input type="number" class="page-input" [ngModel]="editPageNumber"
              (ngModelChange)="editPageNumber = $event" min="1" [max]="totalPages"
              (keyup.enter)="goToPage()" (blur)="goToPage()" #pageInput> of {{ totalPages }}
            </span>
            <button class="btn btn-sm btn-primary" (click)="nextPage()"
            [disabled]="currentPageNumber === totalPages">Next</button>
          </div>
        </p-tabpanel>

        <!-- Favorites Tab -->
        <p-tabpanel [value]="1">
          <div class="favorites-tab">
            <!-- Bulk Selection Controls -->
            <div class="bulk-controls d-flex align-items-center gap-2 mb-2 flex-wrap">
              <button class="btn btn-sm favorites-control-btn"
                [ngClass]="bulkSelectMode ? 'btn-warning' : 'btn-outline-secondary'" (click)="toggleBulkSelectMode()">
                <i class="bi" [ngClass]="bulkSelectMode ? 'bi-x-circle' : 'bi-check2-square'"></i>
                {{ bulkSelectMode ? 'Exit Select' : 'Select' }}
              </button>

              <button class="btn btn-sm btn-outline-success favorites-control-btn" (click)="toggleShowTagManager()">
                <i class="bi bi-folder-plus"></i> Manage Tags
              </button>

              @if (bulkSelectMode) {
                <span class="badge bg-primary">{{ selectedImages.size }} selected</span>
                @if (selectedImages.size > 0) {
                  <div class="bulk-actions d-flex gap-1">
                    <button class="btn btn-sm btn-outline-info" (click)="openTagAssignDialog()" title="Assign to tag">
                      <i class="bi bi-folder-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" (click)="bulkDownload()" title="Download as ZIP">
                      <i class="bi bi-download"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="bulkDelete()" title="Delete selected">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                }
              }
            </div>

            <!-- Tag Filter + Manager -->
            <div class="tag-section mb-3">
              <div class="d-flex align-items-center gap-2 flex-wrap mb-2">
                <button class="btn btn-sm favorites-tag-btn"
                  [ngClass]="selectedTagFilter === null ? 'btn-primary' : 'btn-outline-primary'"
                  (click)="filterByTag(null)">
                  All
                </button>
                @for (tag of availableTags; track tag.id) {
                  <div class="tag-pill">
                    <button class="btn btn-sm favorites-tag-btn tag-filter-btn"
                      [ngClass]="selectedTagFilter === tag.id ? 'btn-primary' : 'btn-outline-secondary'"
                      [style.border-color]="tag.color" [style.color]="selectedTagFilter === tag.id ? '#fff' : tag.color"
                      [style.background-color]="selectedTagFilter === tag.id ? tag.color : null"
                      (click)="filterByTag(tag.id)">
                      {{ tag.name }} ({{ tag.imageCount || 0 }})
                    </button>
                    @if (showTagManager) {
                      <button type="button" class="tag-delete-btn"
                        (click)="$event.stopPropagation(); deleteTag(tag)" aria-label="Delete tag">
                        <i class="bi bi-x-circle"></i>
                      </button>
                    }
                  </div>
                }
              </div>

              <!-- Tag Manager Inline Panel -->
              @if (showTagManager) {
                <div class="tag-manager-panel card p-3 mb-2">
                  <h6>Create New Tag</h6>
                  <div class="d-flex gap-2 mb-2">
                    <input type="text" class="form-control form-control-sm" placeholder="Tag name..." [ngModel]="newTagName"
                      (ngModelChange)="newTagName = $event" (keyup.enter)="createTag()">
                      <button class="btn btn-sm btn-success" (click)="createTag()" [disabled]="!newTagName.trim()">
                        <i class="bi bi-plus"></i> Create
                      </button>
                    </div>
                  </div>
                }
              </div>
            </div>

            <!-- Favorites Content -->
            <div class="sorting-options">
              <div class="search-bar">
                <input type="text" pInputText placeholder="Search prompts" [ngModel]="favoriteSearchQuery"
                  (ngModelChange)="onFavoriteSearchQueryChange($event)">
                </div>
                <div class="density-controls">
                  <label class="density-label" for="imagesPerPageFavorites">Images per page</label>
                  <select id="imagesPerPageFavorites" class="form-select form-select-sm" [ngModel]="imagesPerPage"
                    (ngModelChange)="onImagesPerPageChange($event)" aria-label="Images per page">
                    @for (option of imagesPerPageOptions; track option) {
                      <option [ngValue]="option">
                        {{ option }} per page
                      </option>
                    }
                  </select>
                </div>
              </div>
              <div class="history-grid" [style.--history-columns]="gridColumns" [class.compact-grid]="gridColumns >= 4">
                @if (isLoadingFavorites && favoritePageImages.length === 0) {
                  @for (_ of getPlaceholders(favoriteImagesPerPage); track _) {
                    <div class="history-item placeholder">
                      <div class="image-container">
                        <div class="image-skeleton"></div>
                      </div>
                    </div>
                  }
                }
                @if (favoritePageImages.length > 0) {
                  @for (image of favoritePageImages; track imageTrackKey(image, $index)) {
                    <div class="history-item"
                      [class.selected]="bulkSelectMode && isImageSelected(image)">
                      <div class="image-container">
                        <img [attr.src]="image.url || null" alt="Generated Image" loading="eager" decoding="sync"
                          (load)="onImageElementLoad(image, $event)" (error)="onImageElementError(image, $event)"
                          (click)="onFavoriteImageClick(image, $event)">
                        <!-- Selection checkbox overlay -->
                        @if (bulkSelectMode) {
                          <div class="selection-checkbox"
                            (click)="toggleImageSelection(image, $event)">
                            <i class="bi" [ngClass]="isImageSelected(image) ? 'bi-check-circle-fill' : 'bi-circle'"></i>
                          </div>
                        }
                        @if (!bulkSelectMode) {
                          <div class="top-left-icon">
                            <i class="fa" [ngClass]="image.favorite ? 'bi bi-star-fill' : 'bi bi-star'"
                            (click)="$event.stopPropagation(); toggleFavorite(image)" aria-label="Toggle Favorite"></i>
                          </div>
                        }
                        @if (!bulkSelectMode) {
                          <div class="bottom-left-icon">
                            <i class="bi bi-download"
                              (click)="$event.stopPropagation(); downloadImage(image, $event)"
                            aria-label="Download Image"></i>
                          </div>
                        }
                        @if (!bulkSelectMode) {
                          <div class="top-right-icon">
                            <i class="bi bi-trash" (click)="$event.stopPropagation(); deleteImage(image)"
                            aria-label="Delete Image"></i>
                          </div>
                        }
                        @if (!bulkSelectMode) {
                          <div class="bottom-right-icon">
                            <i class="bi bi-info-circle" [class.active]="isImageInfoOpen(image)"
                            (click)="toggleImageInfo(image, $event)" aria-label="Image info"></i>
                          </div>
                        }
                        @if (!bulkSelectMode && isImageInfoOpen(image)) {
                          <div class="image-info-overlay"
                            (click)="$event.stopPropagation(); toggleImageInfo(image, $event)">
                            <div class="info-line">
                              <span class="info-label">Date</span>
                              <span class="info-value">{{ image.timestamp | date:'short' }}</span>
                            </div>
                            <div class="info-line">
                              <span class="info-label">Model</span>
                              <span class="info-value">{{ image.model || 'Unknown' }}</span>
                            </div>
                            <div class="info-line">
                              <span class="info-label">Seed</span>
                              <span class="info-value">{{ image.seed ?? '—' }}</span>
                            </div>
                            <div class="info-line">
                              <span class="info-label">LoRAs</span>
                              <span class="info-value">{{ formatLoras(image) }}</span>
                            </div>
                            <div class="info-line">
                              <span class="info-label">Prompt</span>
                              <span class="info-value">{{ image.promptSummary || image.prompt || 'No prompt' }}</span>
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }
                  @for (_ of getPlaceholders(favoriteImagesPerPage - favoritePageImages.length); track _) {
                    <div
                      class="history-item placeholder ghost">
                      <div class="image-container">
                        <div class="image-skeleton"></div>
                      </div>
                    </div>
                  }
                }
              </div>
              <!-- Show message if no images are available -->
              @if (favoritePageImages.length === 0 && !isLoadingFavorites) {
                <div class="no-images-message">
                  No favorite images available.
                </div>
              }
              <div class="pagination">
                <button class="btn btn-sm btn-primary" (click)="previousFavoritePage()"
                [disabled]="favoriteCurrentPageNumber === 1">Previous</button>
                <span class="page-edit-container">
                  Page <input type="number" class="page-input" [ngModel]="editFavoritePageNumber"
                  (ngModelChange)="editFavoritePageNumber = $event" min="1" [max]="favoriteTotalPages"
                  (keyup.enter)="goToFavoritePage()" (blur)="goToFavoritePage()" #favoritePageInput> of {{
                  favoriteTotalPages }}
                </span>
                <button class="btn btn-sm btn-primary" (click)="nextFavoritePage()"
                [disabled]="favoriteCurrentPageNumber === favoriteTotalPages">Next</button>
              </div>
            </p-tabpanel>
          </p-tabpanels>
        </p-tabs>
        </div>
      </div>

      <!-- Tag Assignment Dialog -->
      <p-dialog [visible]="showTagAssignDialog" (visibleChange)="onTagAssignDialogVisibleChange($event)" [modal]="true"
        [dismissableMask]="true" [closable]="true" [style]="{width: 'min(90vw, 400px)'}" header="Assign to Tag">
        <ng-template pTemplate="content">
          <p>Select a tag to add {{ tagAssignImageUUIDs.length }} image(s) to:</p>
          <div class="d-flex flex-wrap gap-2 mt-3">
            @for (tag of availableTags; track tag.id) {
              <button class="btn btn-outline-primary" [style.border-color]="tag.color"
                [style.color]="tag.color" (click)="assignTagToImages(tag)">
                <i class="bi bi-folder"></i> {{ tag.name }}
              </button>
            }
          </div>
          @if (availableTags.length === 0) {
            <div class="text-muted mt-3">
              No Tags yet. Create one in the Favorites tab!
            </div>
          }
        </ng-template>
      </p-dialog>
